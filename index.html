<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Creative Writing Adventure</title>
    <!-- Webpage icon -->
    <link rel="icon" type="image/png" href="./img/logo.png" />
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Cinzel+Decorative:wght@700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Noto+Sans+JP:wght@400;700&family=Roboto:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        /* --- 0. GLOBAL RESET & BOX SIZING --- */
        * { box-sizing: border-box; }

        /* --- 1. BASE VARIABLES (Standard Theme) --- */
        :root {
            --bg-color: #f4f6f8;
            --container-bg: #ffffff;
            --primary-color: #3498db;
            --primary-text: #ffffff;
            --secondary-color: #ecf0f1;
            --secondary-text: #2c3e50;
            --accent-color: #2980b9;
            --border-style: 1px solid #bdc3c7;
            --font-header: 'Roboto', sans-serif;
            --font-body: 'Roboto', sans-serif;
            --radius: 8px;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --bg-pattern: none;
            --timer-bg: #3498db;
            --modal-bg: rgba(0,0,0,0.5);
        }

        /* --- 2. DEMON SLAYER THEME (Taisho Era) --- */
        [data-theme="demon"] {
            --bg-color: #123428;
            --container-bg: #fdfbf7;
            --primary-color: #2ecc71;
            --primary-text: #000000;
            --secondary-color: #ffffff;
            --secondary-text: #123428;
            --accent-color: #8e44ad;
            --border-style: 4px double #123428;
            --font-header: 'Cinzel Decorative', cursive;
            --font-body: 'Crimson Text', serif;
            --radius: 4px;
            --shadow: 0 0 20px rgba(0,0,0,0.7);
            --bg-pattern: 
                linear-gradient(45deg, #1a4a3b 25%, transparent 25%, transparent 75%, #1a4a3b 75%, #1a4a3b),
                linear-gradient(45deg, #1a4a3b 25%, transparent 25%, transparent 75%, #1a4a3b 75%, #1a4a3b);
            --timer-bg: #c0392b;
            --modal-bg: rgba(18, 52, 40, 0.95);
        }

        /* --- 3. MY HERO ACADEMIA THEME (Comic Book) --- */
        [data-theme="mha"] {
            --bg-color: #f1c40f;
            --container-bg: #ffffff;
            --primary-color: #e74c3c;
            --primary-text: #ffffff;
            --secondary-color: #3498db;
            --secondary-text: #ffffff;
            --accent-color: #2c3e50;
            --border-style: 3px solid #000000;
            --font-header: 'Bangers', cursive;
            --font-body: 'Roboto', sans-serif;
            --radius: 0px;
            --shadow: 8px 8px 0px rgba(0,0,0,1);
            --bg-pattern: radial-gradient(#e67e22 15%, transparent 16%), radial-gradient(#e67e22 15%, transparent 16%);
            --timer-bg: #e74c3c;
            --modal-bg: rgba(44, 62, 80, 0.95);
        }

        /* --- 4. LORD OF THE RINGS THEME (Middle Earth) --- */
        [data-theme="lotr"] {
            --bg-color: #2b2b2b;
            --container-bg: #f3e5ab;
            --primary-color: #8b4513;
            --primary-text: #f1c40f;
            --secondary-color: #556b2f;
            --secondary-text: #ffffff;
            --accent-color: #d4af37;
            --border-style: 2px solid #8b4513;
            --font-header: 'MedievalSharp', cursive;
            --font-body: 'Crimson Text', serif;
            --radius: 15px;
            --shadow: 0 0 30px rgba(212, 175, 55, 0.15);
            --bg-pattern: none;
            --timer-bg: #8b4513;
            --modal-bg: rgba(43, 43, 43, 0.95);
        }

        /* --- LAYOUT & UTILITIES --- */
        body {
            font-family: var(--font-body);
            background-color: var(--bg-color);
            background-image: var(--bg-pattern);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            color: #333;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            transition: all 0.5s ease;
        }

        .container {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            border: var(--border-style);
            position: relative;
            overflow: hidden; /* Keeps content inside rounded corners */
        }

        /* Decor for Demon Theme */
        [data-theme="demon"] .container::before, [data-theme="demon"] .container::after {
            content: "‚ú¶"; position: absolute; font-size: 2rem; color: var(--accent-color); top: 10px;
        }
        [data-theme="demon"] .container::before { left: 15px; } [data-theme="demon"] .container::after { right: 15px; }

        /* HEADER */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        h1, h2, h3 {
            font-family: var(--font-header);
            color: var(--text-main);
            text-align: center;
            margin-top: 0;
            line-height: 1.2;
        }
        
        h1 { 
            width: 100%;
            font-size: 2.5rem; 
            color: var(--primary-color);
            text-shadow: 1px 1px 0px rgba(0,0,0,0.1); 
            margin-top: 10px;
        }
        
        [data-theme="demon"] h1 { color: #123428; border-bottom: 2px solid var(--accent-color); }
        [data-theme="mha"] h1 { color: #c0392b; -webkit-text-stroke: 1px black; letter-spacing: 2px; transform: skew(-5deg); }
        [data-theme="lotr"] h1 { color: #3e2723; text-shadow: 0 2px 4px rgba(212, 175, 55, 0.5); }

        .top-controls { display: flex; gap: 10px; align-items: center; }
        select#themeSelect {
            padding: 8px;
            border-radius: 4px;
            border: 2px solid #ccc;
            font-weight: bold;
            cursor: pointer;
            background: #fff;
            max-width: 180px;
        }

        /* Wizard Nav */
        .steps-nav {
            display: flex; gap: 10px; margin-bottom: 25px; 
            background: rgba(0,0,0,0.05); padding: 8px; border-radius: 50px;
            flex-wrap: wrap; /* Allows wrapping on very small screens */
        }
        .step-pill {
            flex: 1; text-align: center; padding: 10px; cursor: pointer; 
            border-radius: 40px; font-weight: bold; opacity: 0.6; transition: 0.3s;
            font-family: var(--font-header);
            white-space: nowrap;
        }
        .step-pill.active {
            background: var(--primary-color); color: var(--primary-text);
            opacity: 1; transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        [data-theme="mha"] .steps-nav, [data-theme="mha"] .step-pill { border-radius: 0; }
        [data-theme="mha"] .step-pill.active { border: 2px solid black; transform: skew(-10deg); }

        /* Inputs & Controls */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-family: var(--font-header); }
        
        input[type="text"], input[type="password"], textarea, select {
            width: 100%; padding: 12px; margin-top: 5px;
            border: var(--border-style); border-radius: 4px;
            background: rgba(255,255,255,0.9);
            font-family: var(--font-body); font-size: 1rem;
            max-width: 100%;
        }

        button {
            padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer;
            font-family: var(--font-header); font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.2s; margin: 5px 0;
        }
        button.primary {
            background: var(--primary-color); color: var(--primary-text);
            border: 1px solid rgba(0,0,0,0.1);
        }
        button.secondary {
            background: var(--secondary-color); color: var(--secondary-text);
            border: 1px solid rgba(0,0,0,0.2);
        }
        
        [data-theme="mha"] button { border: 2px solid black; box-shadow: 4px 4px 0px black; transform: skew(-5deg); }
        [data-theme="mha"] button:active { box-shadow: 0px 0px 0px black; transform: translate(4px, 4px) skew(-5deg); }
        [data-theme="lotr"] button { border: 1px solid #d4af37; }

        button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        button:hover:not(:disabled) { filter: brightness(1.1); }

        /* Steps & Animations */
        .step { display: none; }
        .step.active { display: block; animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Features */
        .timer-box {
            text-align: center; margin: 15px 0; padding: 10px;
            background: rgba(0,0,0,0.03); border-radius: 8px;
        }
        .timer-display {
            font-size: 2rem; font-family: var(--font-header); font-weight: bold;
            color: white; background: var(--timer-bg);
            padding: 5px 20px; border-radius: 20px; display: inline-block;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .camera-wrapper { display: none; background: #000; margin: 10px 0; text-align: center; border-radius: 8px; overflow: hidden; }
        video { width: 100%; max-height: 300px; object-fit: cover; }
        img { max-width: 100%; border-radius: 8px; margin-top: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); display: none; }

        .model-selection-area { 
            background: rgba(0,0,0,0.04); padding: 15px; border-radius: 8px; 
            margin-bottom: 15px; border: 1px dashed #ccc; 
        }
        .model-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }

        /* Grading Result */
        #gradingResults { margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.8); border-left: 6px solid var(--primary-color); overflow-x: auto; }
        /* Ensure markdown tables don't break layout */
        #gradingResults table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        #gradingResults th, #gradingResults td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        
        .loading { display: none; text-align: center; margin: 20px; color: var(--primary-color); font-weight: bold; font-style: italic; }
        .loading::after { content: "..."; animation: dots 1.5s infinite; }
        @keyframes dots { 0%, 20% { content: "."; } 40% { content: ".."; } 60%, 100% { content: "..."; } }

        .wizard-footer { margin-top: 30px; display: flex; justify-content: space-between; border-top: 1px solid #ddd; padding-top: 20px; }
        .or-divider { text-align: center; margin: 15px 0; font-weight: bold; opacity: 0.5; font-size: 0.8rem; }

        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .reference-container {
            background: rgba(0,0,0,0.03); padding: 10px; border-radius: 8px;
            margin-bottom: 15px; text-align: center; border: 1px dashed #ccc;
        }
        .reference-img { max-height: 200px; max-width: 100%; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin: 5px auto; display: none; }

        /* --- MODAL STYLES --- */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; 
            overflow: auto; background-color: var(--modal-bg); animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: var(--container-bg); margin: 5vh auto; padding: 25px; 
            border: var(--border-style); border-radius: var(--radius);
            width: 90%; max-width: 700px; position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); color: #333;
        }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; margin-top: -10px; }
        .close-modal:hover { color: var(--primary-color); }
        .guide-section { display: none; }
        .guide-section.active { display: block; }
        .guide-footer { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 0.9rem; text-align: center; }
        .guide-footer a { color: var(--primary-color); text-decoration: none; font-weight: bold; }

        /* --- RESPONSIVE / MOBILE STYLES (iPhone SE & Android) --- */
        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            
            /* Header */
            h1 { font-size: 1.8rem; }
            
            /* Nav Pills */
            .steps-nav { gap: 5px; }
            .step-pill { font-size: 0.8rem; padding: 8px 4px; min-width: 45%; }

            /* Top Bar & Theme Select */
            .top-bar { justify-content: space-between; }
            select#themeSelect { width: 140px; font-size: 0.85rem; }
            #helpBtn { padding: 8px 10px; }

            /* Models */
            .model-row { flex-direction: column; align-items: stretch; }
            .model-row label { margin-bottom: 2px; }
            .model-selection-area div[style*="margin-left"] { margin-left: 0 !important; margin-top: 10px !important; }
            
            /* Inputs */
            .input-grid { grid-template-columns: 1fr; }
            textarea { font-size: 16px; } /* Prevents zoom on iOS */

            /* Grading Area */
            #gradingResults { padding: 10px; }
            
            /* Decor Hiding (Too wide for small screens) */
            [data-theme="demon"] .container::before, [data-theme="demon"] .container::after { display: none; }
        }
    </style>
</head>
<body data-theme="standard">

    <!-- HELP MODAL -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            
            <!-- Standard Guide -->
            <div class="guide-section active" data-guide="standard">
                <h2>How to Use This App</h2>
                <ol style="line-height: 1.6;">
                    <li><strong>API Key:</strong> Get a free API key from <a href="https://openrouter.ai" target="_blank">OpenRouter.ai</a>. This key allows the app to talk to AI models. We do not save this key; it stays on your device.</li>
                    <li><strong>Visualization:</strong> Upload an image, use your camera, or paste a link to inspire your creative writing prompt.</li>
                    <li><strong>Writing:</strong> Write your story on paper and take a photo (we'll convert it to text!), or type it directly into the app.</li>
                    <li><strong>Grading:</strong> The AI will grade your work based on GATE standards. You can download your full portfolio (image + story + grade) as a ZIP file.</li>
                </ol>
                <p><em><strong>Tip:</strong> Select "Free Only" to use this app completely free of charge!</em></p>
            </div>

            <!-- Demon Slayer Guide -->
            <div class="guide-section" data-guide="demon">
                <h2>‚öîÔ∏è Demon Slayer's Handbook</h2>
                <ol style="line-height: 1.6;">
                    <li><strong>Forge Your Nichirin Key:</strong> Obtain your spirit key from <a href="https://openrouter.ai" target="_blank">OpenRouter</a>. This key allows you to summon the AI spirits. It is safe in your scabbard (your device only).</li>
                    <li><strong>Visualize the Demon:</strong> Use your inner eye (camera/upload) to reveal the target scene for your mission.</li>
                    <li><strong>Total Concentration Writing:</strong> Inscribe your story on a scroll (paper) and photograph it, or write directly with your mind.</li>
                    <li><strong>Hashira Assessment:</strong> Submit your work to the Hashiras. Receive your rank and download your mission report.</li>
                </ol>
                <p><em><strong>Note:</strong> Use "Free Spirits" to train without cost!</em></p>
            </div>

            <!-- MHA Guide -->
            <div class="guide-section" data-guide="mha">
                <h2>üí• U.A. Student Guide</h2>
                <ol style="line-height: 1.6;">
                    <li><strong>Hero License ID:</strong> Register at <a href="https://openrouter.ai" target="_blank">OpenRouter</a> to get your access code. This activates your quirk (AI). Secure it locally!</li>
                    <li><strong>Target Acquisition:</strong> Upload visual intel (image) to generate a combat scenario.</li>
                    <li><strong>Combat Strategy:</strong> Write your hero's journey on paper (scan it!) or type it into the database.</li>
                    <li><strong>Pro Hero Evaluation:</strong> Get graded by the faculty. Download your Hero Portfolio to track your progress.</li>
                </ol>
                <p><em><strong>Plus Ultra:</strong> Select free models to train for free!</em></p>
            </div>

            <!-- LOTR Guide -->
            <div class="guide-section" data-guide="lotr">
                <h2>üìú Scroll of Guidance</h2>
                <ol style="line-height: 1.6;">
                    <li><strong>The Secret Word:</strong> Acquire the key from <a href="https://openrouter.ai" target="_blank">OpenRouter</a>. Speak friend and enter. The key is kept secret, safe on your own machine.</li>
                    <li><strong>Vision in the Palantir:</strong> Reveal a vision (image) to spark the tale of your fellowship.</li>
                    <li><strong>Inscribe the Tale:</strong> Write upon parchment and capture it with the lens, or scribe directly into the tome.</li>
                    <li><strong>Council's Judgment:</strong> The Wise will assess your lore. Archive your scroll (Download) for the ages.</li>
                </ol>
                <p><em><strong>Note:</strong> Use free magic to avoid paying toll!</em></p>
            </div>

            <div class="guide-footer">
                <p>Developed by <strong><a href="https://son-n-pham.github.io/" target="_blank">Son Pham</a></strong></p>
                <p>Open Source Project: <a href="https://github.com/son-n-pham/creative-writing" target="_blank">GitHub Repository</a></p>
                <p>This app is designed to be <strong>free</strong> when using free models from OpenRouter.</p>
            </div>
        </div>
    </div>

    <div class="container wizard">
        <div class="top-bar">
            <button id="helpBtn" class="secondary" style="margin:0; padding: 8px 15px; font-size: 0.9rem;">‚ùì Guide</button>
            <div class="top-controls">
                <select id="themeSelect">
                    <option value="standard">Standard Theme</option>
                    <option value="demon">Demon Slayer</option>
                    <option value="mha">My Hero Academia</option>
                    <option value="lotr">Lord of the Rings</option>
                </select>
            </div>
        </div>

        <div class="wizard-header">
            <h1 id="appTitle">Creative Writing Adventure</h1>
            <div class="steps-nav">
                <div class="step-pill active" onclick="showStep(1)">1. API Key</div>
                <div class="step-pill" onclick="showStep(2)">2. Vision</div>
                <div class="step-pill" onclick="showStep(3)">3. Writing</div>
                <div class="step-pill" onclick="showStep(4)">4. Grading</div>
            </div>
        </div>

        <!-- STEP 1: API KEY -->
        <div class="step active" data-step="1">
            <h2 id="step1Title">Setup Your Access</h2>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2196f3; font-family: sans-serif;">
                <strong>‚ÑπÔ∏è Free Usage:</strong> This app uses OpenRouter. Use free models like Google Gemini Flash or Grok.
            </div>

            <div class="input-group">
                <label>OpenRouter API Key:</label>
                <input type="password" id="apiKey" placeholder="sk-or-..." />
            </div>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" id="rememberApiKey" /> <span style="font-size: 0.9rem;">Remember Me</span>
                </label>
                <div style="margin-left: auto; display: flex; gap: 5px;">
                    <button id="validateApiKeyBtn" class="primary">Validate Key</button>
                    <button id="clearApiKeyBtn" class="secondary">Clear</button>
                </div>
            </div>
            <div style="margin-top: 10px; font-weight: bold; text-align: right;">
                Status: <span id="apiKeyStatus" style="background:#eee; padding: 2px 6px; border-radius:4px;">Not Validated</span>
            </div>
        </div>

        <!-- STEP 2: PROMPT GENERATION -->
        <div class="step" data-step="2">
            <h2 id="step2Title">Visualize the Scene</h2>
            
            <div class="model-selection-area">
                <div class="model-row">
                    <label>Provider:</label>
                    <select id="providerSelect"><option>All</option></select>
                </div>
                <div class="model-row">
                    <label>Model:</label>
                    <select id="modelSelect"><option>Loading...</option></select>
                    <button id="refreshModelsBtn" class="secondary">‚Üª</button>
                </div>
                <div id="modelInfo" style="font-size: 0.8rem; color: #666; margin-left: 80px;"></div>
                <div style="margin-top:10px; margin-left: 80px;">
                    <label style="display:inline;"><input type="checkbox" id="freeOnlyToggle" checked> Free Only</label>
                    <label style="display:inline; margin-left:10px;"><input type="checkbox" id="visionOnlyToggle" checked> Vision</label>
                </div>
            </div>

            <!-- New Input Methods -->
            <div class="input-group">
                <label>Choose Image Source:</label>
                
                <!-- File Upload -->
                <div style="margin-bottom: 10px;">
                    <input type="file" id="imageInput" accept="image/*" />
                </div>
                <div class="or-divider">OR</div>
                
                <!-- Link Input -->
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="imageUrlInput" placeholder="Paste Image URL here..." />
                    <button id="loadImageBtn" class="secondary" style="margin: 0;">Load Link</button>
                </div>
                <div class="or-divider">OR</div>
                
                <!-- Buttons Grid -->
                <div class="input-grid">
                    <button id="cameraBtn" class="secondary">üì∏ Use Camera</button>
                    <button id="screenshotBtn" class="secondary">üñ•Ô∏è Screenshot</button>
                </div>
            </div>

            <div id="cameraContainer" class="camera-wrapper">
                <video id="cameraVideo" autoplay playsinline></video>
                <div style="padding:10px;">
                    <button id="captureBtn" class="primary">Capture</button>
                    <button id="cancelCameraBtn" class="secondary">Cancel</button>
                </div>
            </div>

            <img id="imagePreview" alt="Preview" />
            <div class="loading" id="loading">Generating Creative Prompt...</div>
            <div id="result" style="margin-top:15px; padding:15px; background:rgba(255,255,255,0.5); border-radius:6px; display:none; border: 1px solid #ccc;"></div>
        </div>

        <!-- STEP 3: WRITING -->
        <div class="step" data-step="3">
            <h2 id="step3Title">Write Your Story</h2>

            <!-- REFERENCE IMAGE (NEW) -->
            <div class="reference-container">
                <label style="margin-bottom: 0;">Your Inspiration:</label>
                <img id="referenceImage" class="reference-img" alt="Reference" />
                <div id="noRefMsg" style="font-size: 0.8rem; color: #666; font-style: italic; display:none;">(No image selected in Step 2)</div>
            </div>

            <!-- TIMER -->
            <div class="timer-box">
                <div class="timer-display" id="timerDisplay">25:00</div>
                <div style="margin-top:10px;">
                    <button id="startTimerBtn" class="primary" style="padding: 5px 15px; font-size: 0.9rem;">Start Timer</button>
                    <button id="resetTimerBtn" class="secondary" style="padding: 5px 15px; font-size: 0.9rem;">Reset</button>
                </div>
            </div>
            
            <div class="model-selection-area">
                <div class="model-row">
                    <label>Handwriting AI:</label>
                    <select id="handwritingModelSelect"><option>Loading...</option></select>
                    <select id="handwritingProviderSelect" style="display:none"></select>
                </div>
                <div style="margin-top:5px; margin-left: 80px;">
                    <label style="display:inline;"><input type="checkbox" id="freeOnlyToggleHandwriting" checked> Free Only</label>
                </div>
            </div>

            <div class="input-group">
                <label>Story Input Method:</label>
                <div style="border: 1px solid #ccc; padding: 10px; border-radius: 4px; background: rgba(255,255,255,0.5);">
                    <div style="margin-bottom: 10px;">
                        <input type="file" id="handwritingInput" accept="image/*" />
                    </div>
                    <div class="or-divider">OR</div>
                    <button id="hwCameraBtn" class="secondary" style="width:100%">Photograph Handwriting</button>
                    
                    <div id="hwCameraContainer" class="camera-wrapper">
                        <video id="hwCameraVideo" autoplay playsinline></video>
                        <div style="padding:10px;">
                            <button id="hwCaptureBtn" class="primary">Capture</button>
                            <button id="hwCancelCameraBtn" class="secondary">Cancel</button>
                        </div>
                    </div>
                    
                    <img id="handwritingPreview" style="margin: 10px auto;" />
                    <button id="extractTextBtn" class="primary" style="width:100%; margin-top:10px;" disabled>Convert Handwriting to Text</button>
                </div>
            </div>
            
            <div class="loading" id="handwritingLoading">Deciphering Text...</div>
            
            <div class="input-group">
                <label>Story Text (Editable):</label>
                <textarea id="extractedText" rows="10" placeholder="Your story text will appear here..."></textarea>
            </div>
        </div>

        <!-- STEP 4: GRADING -->
        <div class="step" data-step="4">
            <h2 id="step4Title">Assessment</h2>
            
            <div class="model-selection-area">
                <div class="model-row">
                    <label>Grader AI:</label>
                    <select id="gradingModelSelect" disabled><option>Select Model</option></select>
                    <select id="gradingProviderSelect" style="display:none"></select>
                </div>
                <div style="margin-top:5px; margin-left: 80px;">
                    <label><input type="checkbox" id="freeOnlyToggleGrading" checked> Free Only</label>
                </div>
            </div>

            <!-- Hidden Inputs for logic -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                <div>
                    <label>Prompt:</label>
                    <textarea id="writingPrompt" rows="3" readonly style="background:#eee; font-size:0.8rem;"></textarea>
                </div>
                <div>
                    <label>Story:</label>
                    <textarea id="studentWriting" rows="3" readonly style="background:#eee; font-size:0.8rem;"></textarea>
                </div>
            </div>

            <button id="gradeWritingBtn" class="primary" style="width:100%; padding:15px; font-size:1.1rem;" disabled>Start Evaluation</button>
            <div class="loading" id="gradingLoading">Evaluating against GATE Rubric...</div>

            <div id="gradingResults" style="display:none;">
                <h3>Report Card</h3>
                <div id="gradingOutput"></div>
                <hr style="margin: 20px 0; border-top: 1px solid #ccc;">
                <button id="downloadPortfolioBtn" class="secondary" style="width:100%; font-weight:bold; padding:15px;">üì• Download Full Portfolio (ZIP)</button>
            </div>
        </div>

        <div class="wizard-footer">
            <button id="wizardBack" class="secondary" disabled>‚óÄ Back</button>
            <button id="wizardNext" class="primary">Next ‚ñ∂</button>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const DEFAULT_MODEL = 'google/gemini-flash-1.5:free';
        let availableModels = [];
        let availableProviders = [];
        let freeOnly = true;
        let failedModels = new Set();
        let currentStep = 1;
        
        // --- TEXT CONFIGS ---
        const themeConfig = {
            standard: { title: "Creative Writing Adventure", btnNext: "Next ‚ñ∂", btnGrade: "Grade My Work" },
            demon: { title: "Demon Slayer Writing Academy", btnNext: "Advance ‚ñ∂", btnGrade: "Summon Hashira Judge" },
            mha: { title: "U.A. High Entrance Exam", btnNext: "Plus Ultra! ‚ñ∂", btnGrade: "Final Smash Assessment" },
            lotr: { title: "Chronicles of Middle Earth", btnNext: "Journey On ‚ñ∂", btnGrade: "Consult the Council" }
        };

        // --- DOM ELEMENTS ---
        const els = {
            theme: document.getElementById('themeSelect'),
            title: document.getElementById('appTitle'),
            steps: document.querySelectorAll('.step'),
            pills: document.querySelectorAll('.step-pill'),
            back: document.getElementById('wizardBack'),
            next: document.getElementById('wizardNext'),
            apiKey: document.getElementById('apiKey'),
            status: document.getElementById('apiKeyStatus'),
            
            // Modal
            helpBtn: document.getElementById('helpBtn'),
            modal: document.getElementById('helpModal'),
            closeModal: document.querySelector('.close-modal'),
            
            // Step 2
            provSel: document.getElementById("providerSelect"),
            modSel: document.getElementById("modelSelect"),
            modInfo: document.getElementById("modelInfo"),
            imgIn: document.getElementById("imageInput"),
            urlIn: document.getElementById("imageUrlInput"),
            loadUrlBtn: document.getElementById("loadImageBtn"),
            screenshotBtn: document.getElementById("screenshotBtn"),
            imgPrev: document.getElementById("imagePreview"),
            result: document.getElementById("result"),
            loading: document.getElementById("loading"),

            // Step 3
            refImg: document.getElementById("referenceImage"),
            noRefMsg: document.getElementById("noRefMsg"),
            hwModSel: document.getElementById("handwritingModelSelect"),
            hwProvSel: document.getElementById("handwritingProviderSelect"),
            hwIn: document.getElementById("handwritingInput"),
            hwPrev: document.getElementById("handwritingPreview"),
            extBtn: document.getElementById("extractTextBtn"),
            extText: document.getElementById("extractedText"),
            hwLoad: document.getElementById("handwritingLoading"),
            timerDisplay: document.getElementById("timerDisplay"),

            // Step 4
            grModSel: document.getElementById("gradingModelSelect"),
            grProvSel: document.getElementById("gradingProviderSelect"),
            wPrompt: document.getElementById("writingPrompt"),
            sWriting: document.getElementById("studentWriting"),
            gradeBtn: document.getElementById("gradeWritingBtn"),
            grLoad: document.getElementById("gradingLoading"),
            grRes: document.getElementById("gradingResults"),
            grOut: document.getElementById("gradingOutput"),
            dlZip: document.getElementById("downloadPortfolioBtn"),

            // Toggles
            freeTog: document.getElementById("freeOnlyToggle"),
            visTog: document.getElementById("visionOnlyToggle"),
            freeTogHw: document.getElementById("freeOnlyToggleHandwriting"),
            freeTogGr: document.getElementById("freeOnlyToggleGrading")
        };

        // --- MODAL LOGIC ---
        els.helpBtn.addEventListener('click', () => {
            els.modal.style.display = "block";
            updateHelpText(els.theme.value);
        });
        els.closeModal.addEventListener('click', () => els.modal.style.display = "none");
        window.addEventListener('click', (e) => {
            if (e.target == els.modal) els.modal.style.display = "none";
        });

        function updateHelpText(theme) {
            document.querySelectorAll('.guide-section').forEach(el => el.classList.remove('active'));
            const active = document.querySelector(`.guide-section[data-guide="${theme}"]`) || document.querySelector(`.guide-section[data-guide="standard"]`);
            active.classList.add('active');
        }

        // --- THEME LOGIC ---
        els.theme.addEventListener('change', (e) => {
            const t = e.target.value;
            document.body.setAttribute('data-theme', t);
            els.title.textContent = themeConfig[t].title;
            els.next.textContent = currentStep === 4 ? "Finish" : themeConfig[t].btnNext;
            els.gradeBtn.textContent = themeConfig[t].btnGrade;
            if(els.modal.style.display === 'block') updateHelpText(t);
        });

        // --- NAVIGATION ---
        window.showStep = (step) => {
            els.steps.forEach(s => s.classList.remove('active'));
            els.pills.forEach(p => p.classList.remove('active'));
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
            els.pills[step-1].classList.add('active');
            
            els.back.disabled = step === 1;
            const t = els.theme.value;
            els.next.textContent = step === 4 ? "Finish" : themeConfig[t].btnNext;
            currentStep = step;

            // Step 3 Specific: Update Reference Image
            if(step === 3) {
                if(els.imgPrev.src && els.imgPrev.style.display !== 'none') {
                    els.refImg.src = els.imgPrev.src;
                    els.refImg.style.display = 'inline-block';
                    els.noRefMsg.style.display = 'none';
                } else {
                    els.refImg.style.display = 'none';
                    els.noRefMsg.style.display = 'block';
                }
            }
        };

        els.next.addEventListener('click', () => { if(currentStep < 4) showStep(currentStep+1); });
        els.back.addEventListener('click', () => { if(currentStep > 1) showStep(currentStep-1); });

        // --- TIMER LOGIC ---
        let timerInt;
        let timeLeft = 25 * 60;
        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            els.timerDisplay.textContent = `${m}:${s}`;
            if(timeLeft < 300) els.timerDisplay.style.backgroundColor = 'red';
            else els.timerDisplay.style.backgroundColor = ''; 
        }
        document.getElementById('startTimerBtn').addEventListener('click', () => {
            clearInterval(timerInt);
            timerInt = setInterval(() => {
                if(timeLeft > 0) { timeLeft--; updateTimerDisplay(); }
                else { clearInterval(timerInt); alert("Time is up!"); }
            }, 1000);
        });
        document.getElementById('resetTimerBtn').addEventListener('click', () => {
            clearInterval(timerInt); timeLeft = 25 * 60; updateTimerDisplay();
        });

        // --- MODEL LOGIC ---
        function isFreeModel(model) {
            const p = model?.pricing;
            return p && (p.prompt === 0 || p.prompt === "0") && (p.completion === 0 || p.completion === "0");
        }

        async function loadModels() {
            try {
                const res = await fetch('https://openrouter.ai/api/v1/models');
                const data = await res.json();
                availableModels = data.data.sort((a,b) => (a.name||a.id).localeCompare(b.name||b.id));
                availableProviders = Array.from(new Set(availableModels.map(m => m.id.split('/')[0]))).sort();
                updateAllDropdowns();
            } catch(e) { console.error(e); }
        }

        function updateAllDropdowns() {
            // Filter definitions
            const fVis = m => !els.visTog.checked || (m.architecture?.input_modalities?.includes('image'));
            const fTxt = m => m.architecture?.input_modalities?.includes('text');

            updateProviderDropdown(els.provSel, fVis);
            updateModelDropdown(els.modSel, els.provSel.value, fVis);

            updateProviderDropdown(els.hwProvSel, fVis);
            updateModelDropdown(els.hwModSel, els.hwProvSel.value, fVis);

            updateProviderDropdown(els.grProvSel, fTxt);
            updateModelDropdown(els.grModSel, els.grProvSel.value, fTxt);

            setDefaultModels();
        }

        function updateProviderDropdown(sel, filter) {
            const curr = sel.value;
            sel.innerHTML = '<option value="">All Providers</option>';
            let list = availableProviders;
            if(freeOnly) list = availableProviders.filter(p => availableModels.some(m => m.id.startsWith(p+'/') && isFreeModel(m) && filter(m)));
            list.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p; opt.textContent = p.charAt(0).toUpperCase()+p.slice(1); sel.appendChild(opt);
            });
            if(list.includes(curr)) sel.value = curr;
        }

        function updateModelDropdown(sel, prov, filter) {
            const curr = sel.value;
            sel.innerHTML = '<option value="">Select Model...</option>';
            let list = availableModels.filter(filter);
            if(freeOnly) list = list.filter(isFreeModel);
            if(prov) list = list.filter(m => m.id.startsWith(prov+'/'));

            list.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id; opt.textContent = m.name || m.id;
                if(failedModels.has(m.id)) { opt.disabled=true; opt.textContent+=" (Down)"; }
                sel.appendChild(opt);
            });
            if(list.some(m=>m.id===curr)) sel.value = curr;
        }

        function setDefaultModels() {
            const grokFree = availableModels.find(m => (m.id.includes('grok') || m.name.toLowerCase().includes('grok')) && isFreeModel(m));
            const googleFlash = availableModels.find(m => m.id.includes('google') && m.id.includes('flash') && isFreeModel(m));
            
            [els.modSel, els.hwModSel, els.grModSel].forEach(sel => {
                if(!sel.value || sel.value === "") {
                    if(grokFree && !sel.querySelector(`option[value="${grokFree.id}"]`)?.disabled) sel.value = grokFree.id;
                    else if(googleFlash && !sel.querySelector(`option[value="${googleFlash.id}"]`)?.disabled) sel.value = googleFlash.id;
                    else sel.value = DEFAULT_MODEL;
                }
            });
            checkBtnStates();
        }

        // --- API HELPERS ---
        async function callApi(model, msgs, loadEl, resEl, cb) {
            loadEl.style.display='block'; if(resEl) resEl.style.display='none';
            try {
                const r = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method:'POST',
                    headers: { 'Authorization': `Bearer ${els.apiKey.value}`, 'Content-Type':'application/json', 'HTTP-Referer': window.location.href },
                    body: JSON.stringify({ model, messages: msgs })
                });
                if(!r.ok) throw new Error(r.statusText);
                const d = await r.json();
                cb(d.choices[0].message.content);
            } catch(e) {
                alert("Error: " + e.message);
                failedModels.add(model);
                updateAllDropdowns();
            } finally {
                loadEl.style.display='none'; if(resEl) resEl.style.display='block';
                checkBtnStates();
            }
        }

        // --- CAMERA & IMAGES ---
        // 1. Standard Camera
        function setupCam(btn, cont, vid, cap, canc, prev, inp, cb) {
            let stream;
            btn.addEventListener('click', async () => {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
                    vid.srcObject = stream; cont.style.display='block'; btn.style.display='none'; prev.style.display='none';
                } catch(e) { alert("Camera access failed."); }
            });
            cap.addEventListener('click', () => {
                const c = document.createElement('canvas'); c.width=vid.videoWidth; c.height=vid.videoHeight;
                c.getContext('2d').drawImage(vid,0,0);
                prev.src=c.toDataURL('image/jpeg'); prev.style.display='block';
                if(stream) stream.getTracks().forEach(t=>t.stop());
                cont.style.display='none'; btn.style.display='block'; if(cb) cb();
            });
            canc.addEventListener('click', () => {
                if(stream) stream.getTracks().forEach(t=>t.stop());
                cont.style.display='none'; btn.style.display='block';
            });
            if(inp) {
                inp.addEventListener('change', e => {
                    const f = e.target.files[0];
                    if(f) {
                        const r = new FileReader();
                        r.onload = ev => { prev.src = ev.target.result; prev.style.display='block'; if(cb) cb(); };
                        r.readAsDataURL(f);
                    }
                });
            }
        }

        setupCam(document.getElementById('cameraBtn'), document.getElementById('cameraContainer'), document.getElementById('cameraVideo'), 
                 document.getElementById('captureBtn'), document.getElementById('cancelCameraBtn'), els.imgPrev, els.imgIn, generatePrompt);
                 
        setupCam(document.getElementById('hwCameraBtn'), document.getElementById('hwCameraContainer'), document.getElementById('hwCameraVideo'), 
                 document.getElementById('hwCaptureBtn'), document.getElementById('hwCancelCameraBtn'), els.hwPrev, els.hwIn, checkBtnStates);

        // 2. Link Loader
        els.loadUrlBtn.addEventListener('click', () => {
            const url = els.urlIn.value.trim();
            if(url) {
                els.imgPrev.src = url;
                els.imgPrev.style.display = 'block';
                generatePrompt();
            }
        });

        // 3. Screenshot
        els.screenshotBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({video: true});
                const vid = document.createElement('video');
                vid.srcObject = stream;
                await vid.play();
                
                const c = document.createElement('canvas'); 
                c.width = vid.videoWidth; c.height = vid.videoHeight;
                c.getContext('2d').drawImage(vid, 0, 0);
                
                els.imgPrev.src = c.toDataURL('image/jpeg');
                els.imgPrev.style.display = 'block';
                
                stream.getTracks().forEach(t => t.stop());
                generatePrompt();
            } catch(e) {
                console.error(e);
            }
        });

        // --- ACTIONS ---
        function generatePrompt() {
            if(!els.imgPrev.src) return;
            const content = [{type:'text', text:'Describe this image for a creative writing prompt. Keep it inspiring for a Grade 6 student.'}, {type:'image_url', image_url: {url: els.imgPrev.src}}];
            callApi(els.modSel.value, [{role:'user', content}], els.loading, els.result, res => {
                els.result.innerHTML = marked.parse(res);
                els.wPrompt.value = res;
                checkBtnStates();
            });
        }

        els.extBtn.addEventListener('click', () => {
            const content = [{type:'text', text:'Transcribe this handwritten text exactly. Do not add commentary.'}, {type:'image_url', image_url: {url: els.hwPrev.src}}];
            callApi(els.hwModSel.value, [{role:'user', content}], els.hwLoad, null, res => {
                els.extText.value = res;
                els.sWriting.value = res;
                checkBtnStates();
            });
        });

        els.extText.addEventListener('input', () => {
            els.sWriting.value = els.extText.value;
            checkBtnStates();
        });

        // --- GATE GRADING LOGIC ---
        function createGradingPrompt(writingPrompt, studentWriting) {
            return `## PURPOSE

You are an expert writing evaluator designed to provide comprehensive, consistent, and constructive feedback on GATE student writing. Your analysis combines technical assessment strictly following the writing assessment rubric below with empathetic guidance to help students improve their writing skills.

## QUICK REFERENCE

- Time Constraint: Student essays written in 25 minutes
- Scoring Range: 0-25 marks
- Output Format: Grading in Markdown format

## WRITING PROMPT

${writingPrompt}

## STUDENT WRITING

${studentWriting}

## EVALUATION PROTOCOL

### 1. EVALUATION PROCESS

A. First Pass: Holistic Review
- Read the complete essay, ensuring it is evaluated independently.
- Identify main themes and approaches.
- Note initial impressions.

B. Second Pass: Detailed Analysis

Score each criterion using the rubric below:

#### WRITING ASSESSMENT RUBRIC (25 MARKS)

1. **Story Structure and Plot Flow (2 marks)**
   - 2 marks: Clear beginning, middle, and end; logical sequence of events; smooth transitions.
   - 1 mark: Basic structure with awkward transitions; some events appear disconnected.
   - 0 marks: No clear structure; random events; confusing sequence.

2. **Topic Relevance (5 marks)**
   - 5 marks: The essay fully and consistently addresses the assigned prompt with deep, nuanced understanding; every section is directly relevant.
   - 4 marks: Largely addresses the prompt with minor deviations; most content is relevant with only slight off-topic areas.
   - 3 marks: Moderately addresses the prompt; key elements are included but with noticeable gaps or generalizations.
   - 2 marks: Limited engagement with the prompt; significant portions are off-topic.
   - 1 mark: Barely touches the topic with isolated references; largely off-topic.
   - 0 marks: Fails to address the prompt entirely.

3. **Atmosphere and Theme (2 marks)**
   - 2 marks: Vivid setting details that reinforce the theme; effective use of sensory cues.
   - 1 mark: Basic atmosphere with an inconsistent mood.
   - 0 marks: Lacks clear atmosphere and theme.

4. **Sensory Details (2 marks)**
   - 2 marks: Incorporates multiple sensory details naturally.
   - 1 mark: Some sensory details present, but they may feel forced.
   - 0 marks: Limited or superficial sensory detail.

5. **Character Development (2 marks)**
   - 2 marks: Main character displays clear growth and distinct personality.
   - 1 mark: Some development present; character traits are basic.
   - 0 marks: Flat characters with no development.

6. **Sizzling Start (1 mark)**
   - 1 mark: Begins with engaging action, dialogue, or intrigue.
   - 0 marks: Generic or slow start.

7. **Conflict Development (2 marks)**
   - 2 marks: Clear central conflict with creative complications and a satisfying resolution.
   - 1 mark: Basic conflict with predictable progression.
   - 0 marks: Unclear or absent conflict.

8. **Figurative Language (3 marks)**
   - 3 marks: Effective use of three or more types of figurative language.
   - 2 marks: Uses two types effectively.
   - 1 mark: Uses one type, or uses multiple types ineffectively.
   - 0 marks: No apparent use of figurative language.

9. **Moral/Theme Message (2 marks)**
   - 2 marks: Moral or underlying message is naturally and thoughtfully integrated.
   - 1 mark: Obvious or forced moral message.
   - 0 marks: Lacks a clear moral or message.

10. **Ending (2 marks)**
    - 2 marks: Concludes with a surprising yet logical ending; ties up loose ends.
    - 1 mark: Concludes adequately but predictably.
    - 0 marks: Abrupt or illogical ending.

11. **Original Idea (1 mark)**
    - 1 mark: Presents a fresh perspective or unique plot elements.
    - 0 marks: Relies on clich√©d or derivative ideas.

12. **Technical Accuracy (1 mark)**
    - 1 mark: Few to no spelling/grammar errors and proper punctuation.
    - 0 marks: Frequent errors and poor technical execution.

### 2. FEEDBACK GENERATION

Please provide your assessment in the following format:

## Grading Report

### Detailed Rubric Assessment

**1. Story Structure and Plot Flow** (_/2 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**2. Topic Relevance** (_/5 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**3. Atmosphere and Theme** (_/2 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**4. Sensory Details** (_/2 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**5. Character Development** (_/2 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**6. Sizzling Start** (_/1 mark)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**7. Conflict Development** (_/2 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**8. Figurative Language** (_/3 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**9. Moral/Theme Message** (_/2 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**10. Ending** (_/2 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**11. Original Idea** (_/1 mark)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**12. Technical Accuracy** (_/1 mark)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

### Overall Assessment

- **Total Score:** _/25 (_%)
- **Key Strengths:** [3 specific elements]
- **Priority Improvements:** [3 actionable items]
- **Strategic Development Plan:** [Personalized roadmap]

Please evaluate the student's writing thoroughly and provide constructive feedback that will help them improve their writing skills.`;
        }

        els.gradeBtn.addEventListener('click', () => {
            const prompt = createGradingPrompt(els.wPrompt.value, els.sWriting.value);
            callApi(els.grModSel.value, [{role:'user', content: prompt}], els.grLoad, els.grRes, res => {
                els.grOut.innerHTML = marked.parse(res);
                window.gradingMarkdown = res;
            });
        });

        // --- ZIP DOWNLOAD ---
        els.dlZip.addEventListener('click', async () => {
            const zip = new JSZip();
            zip.file("prompt.txt", els.wPrompt.value);
            zip.file("story.txt", els.sWriting.value);
            zip.file("report_card.md", window.gradingMarkdown || "No grading generated.");

            const imgData = els.imgPrev.src;
            if (imgData && imgData.startsWith('data:image')) {
                const base64Data = imgData.split(',')[1];
                const ext = imgData.split(';')[0].split('/')[1];
                zip.file(`inspiration_image.${ext}`, base64Data, {base64: true});
            }

            zip.generateAsync({type:"blob"}).then(function(content) {
                saveAs(content, "Creative_Writing_Portfolio.zip");
            });
        });

        // --- INIT ---
        function checkBtnStates() {
            const valid = els.status.textContent.includes('Valid');
            els.extBtn.disabled = !valid || !els.hwPrev.src;
            els.gradeBtn.disabled = !valid || !els.wPrompt.value || !els.sWriting.value;
        }

        document.getElementById('validateApiKeyBtn').addEventListener('click', async () => {
            els.status.textContent = 'Validating...';
            try {
                const r = await fetch('https://openrouter.ai/api/v1/models', {headers:{'Authorization':`Bearer ${els.apiKey.value}`}});
                if(r.ok) {
                    els.status.textContent = '‚úÖ Valid';
                    if(document.getElementById('rememberApiKey').checked) localStorage.setItem('or_key', els.apiKey.value);
                    loadModels();
                } else els.status.textContent = '‚ùå Invalid';
            } catch(e) { els.status.textContent = 'Error'; }
            checkBtnStates();
        });

        document.getElementById('clearApiKeyBtn').addEventListener('click', () => {
            els.apiKey.value = ''; localStorage.removeItem('or_key'); els.status.textContent = 'Not Validated';
        });

        [els.freeTog, els.freeTogHw, els.freeTogGr].forEach(t => t.addEventListener('change', function(){
            freeOnly = this.checked;
            [els.freeTog, els.freeTogHw, els.freeTogGr].forEach(x => x.checked = freeOnly);
            updateAllDropdowns();
        }));
        
        [els.visTog, els.provSel, els.hwProvSel, els.grProvSel].forEach(el => el.addEventListener('change', updateAllDropdowns));
        
        if(localStorage.getItem('or_key')) {
            els.apiKey.value = localStorage.getItem('or_key');
            document.getElementById('validateApiKeyBtn').click();
        } else {
            loadModels();
        }
    </script>
</body>
</html>