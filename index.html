<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Creative Writing Adventure</title>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
        <div class="container wizard">
            <div class="wizard-header">
                <h1>Creative Writing Adventure</h1>
                <div class="steps-nav" aria-hidden="false">
                    <div class="step-pill" role="button" tabindex="0">1. API Key</div>
                    <div class="step-pill" role="button" tabindex="0">2. Image Prompt</div>
                    <div class="step-pill" role="button" tabindex="0">3. Handwriting</div>
                    <div class="step-pill" role="button" tabindex="0">4. Grading</div>
                </div>
                <div class="progress" aria-hidden="true"><i></i></div>
            </div>

            <div class="api-key-section step" data-step="1">
                <h2>Step 1: Your Secret Key</h2>
                <label for="apiKey">Enter your OpenRouter API Key:</label>
                <input
                    type="password"
                    id="apiKey"
                    placeholder="Your secret key goes here!"
                />
                <div class="api-key-actions">
                    <label>
                        <input type="checkbox" id="rememberApiKey" />
                        Remember me
                    </label>
                    <button id="validateApiKeyBtn">Validate Key</button>
                    <button id="clearApiKeyBtn">Clear Key</button>
                    <span id="apiKeyStatus" class="api-key-status pending" data-state="unknown">Not validated</span>
                    <button id="resetAllBtn">Reset All</button>
                </div>
                <p class="help-text" id="apiKeyDisclaimer">Only save your key on a trusted computer!</p>
            </div>

            <div id="imagePromptSection" class="step" data-step="2">
                <h2>Step 2: Picture Your Story</h2>
                <div class="model-selection-area">
                    <label for="freeOnlyToggle">
                        <input type="checkbox" id="freeOnlyToggle" checked>
                        Show Free Models Only
                    </label>
                    <div class="model-selector">
                        <select id="providerSelect">
                            <option value="">All Providers</option>
                        </select>
                        <select id="modelSelect">
                            <option value="">Loading models...</option>
                        </select>
                        <button id="refreshModelsBtn" class="refresh-btn">Refresh</button>
                    </div>
                    <div id="modelInfo" class="model-info"></div>
                </div>

                <div class="upload-section">
                    <label for="imageInput">Upload an Image (or don't!):</label>
                    <input type="file" id="imageInput" accept="image/*" />
                    <p>Get a story idea from a picture, or just ask for a random one!</p>
                    <button id="generateBtn" disabled>Create a Prompt!</button>
                    <img id="imagePreview" alt="Preview" />
                </div>

                <div class="loading" id="loading">Thinking up a cool story idea...</div>
                <div id="result" class="story-prompt"></div>
            </div>

            <div id="userWritingSection" class="step" data-step="3">
                <h2>Step 3: Write Your Masterpiece</h2>
                <div class="model-selection-area">
                    <label for="freeOnlyToggleHandwriting">
                        <input type="checkbox" id="freeOnlyToggleHandwriting" checked>
                        Show Free Models Only
                    </label>
                    <div class="model-selector">
                        <select id="handwritingProviderSelect">
                            <option value="">All Providers</option>
                        </select>
                        <select id="handwritingModelSelect">
                            <option value="">Loading models...</option>
                        </select>
                        <button id="refreshHandwritingModelsBtn" class="refresh-btn">Refresh</button>
                    </div>
                    <div id="handwritingModelInfo" class="model-info"></div>
                </div>

                <div class="writing-area">
                    <label>
                        <input type="checkbox" id="handwritingToggle" checked>
                        Upload a picture of your handwriting
                    </label>
                    <div class="upload-section" id="handwritingUploadSection">
                        <input type="file" id="handwritingInput" accept="image/*" />
                        <p>Let the AI read your handwriting!</p>
                        <img id="handwritingPreview" alt="Handwriting Preview" />
                        <button id="extractTextBtn" disabled>Turn Writing into Text</button>
                    </div>
                    <textarea id="extractedText" rows="10" placeholder="Your story will appear here... or you can type it!"></textarea>
                </div>
                <div class="loading" id="handwritingLoading">Reading your handwriting...</div>
            </div>

            <div class="container step" data-step="4">
                <h2>Step 4: Get Your Grade!</h2>
                <div class="grading-area">
                    <div class="prompt-display">
                        <h3>Your Prompt:</h3>
                        <textarea id="writingPrompt" rows="4" placeholder="Your story prompt will show up here."></textarea>
                        <button id="useImagePromptBtn">Use Current Prompt</button>
                    </div>
                    <div class="writing-display">
                        <h3>Your Story:</h3>
                        <textarea id="studentWriting" rows="12" placeholder="Your story will show up here."></textarea>
                        <button id="useExtractedBtn">Use My Story</button>
                    </div>
                </div>

                <div class="model-selection-area">
                    <label for="freeOnlyToggleGrading">
                        <input type="checkbox" id="freeOnlyToggleGrading" checked>
                        Show Free Models Only
                    </label>
                    <div class="model-selector">
                        <select id="gradingProviderSelect">
                            <option value="">Select Provider</option>
                        </select>
                        <select id="gradingModelSelect" disabled>
                            <option value="">Select Model</option>
                        </select>
                        <button id="refreshGradingModelsBtn" class="refresh-btn">Refresh</button>
                    </div>
                    <div id="gradingModelInfo" class="model-info"></div>
                </div>

                <button id="gradeWritingBtn" disabled>Grade My Story!</button>
                <div class="loading" id="gradingLoading">Checking your amazing work...</div>
            </div>

            <div class="container" id="gradingResults" style="display: none;">
                <h2>Your Report Card!</h2>
                <div id="gradingOutput"></div>
                <button id="downloadGradingBtn">Download Report</button>
            </div>

        <script src="app.js"></script>
        <div class="wizard-footer container" aria-hidden="false">
            <div class="wizard-controls">
                <button id="wizardBack" class="secondary" disabled>◀ Back</button>
                <button id="wizardNext" class="primary">Next ▶</button>
            </div>
            <div class="shortcut-tip">Tip: use Alt+← / Alt+→ to go back and next!</div>
        </div>

        <script>
            const DEFAULT_MODEL = 'google/gemini-flash-1.5:free';
            // DOM Elements
            const apiKeyInput = document.getElementById("apiKey");
            const rememberApiKey = document.getElementById("rememberApiKey");
            const validateApiKeyBtn = document.getElementById("validateApiKeyBtn");
            const clearApiKeyBtn = document.getElementById("clearApiKeyBtn");
            const apiKeyStatus = document.getElementById("apiKeyStatus");
            const resetAllBtn = document.getElementById("resetAllBtn");
            const providerSelect = document.getElementById("providerSelect");
            const modelSelect = document.getElementById("modelSelect");
            const modelInfo = document.getElementById("modelInfo");
            const refreshModelsBtn = document.getElementById("refreshModelsBtn");
            const imageInput = document.getElementById("imageInput");
            const generateBtn = document.getElementById("generateBtn");
            const imagePreview = document.getElementById("imagePreview");
            const loading = document.getElementById("loading");
            const result = document.getElementById("result");
            
            const handwritingProviderSelect = document.getElementById("handwritingProviderSelect");
            const handwritingModelSelect = document.getElementById("handwritingModelSelect");
            const handwritingModelInfo = document.getElementById("handwritingModelInfo");
            const refreshHandwritingModelsBtn = document.getElementById("refreshHandwritingModelsBtn");
            const handwritingToggle = document.getElementById("handwritingToggle");
            const handwritingUploadSection = document.getElementById("handwritingUploadSection");
            const handwritingInput = document.getElementById("handwritingInput");
            const handwritingPreview = document.getElementById("handwritingPreview");
            const extractTextBtn = document.getElementById("extractTextBtn");
            const extractedText = document.getElementById("extractedText");
            const handwritingLoading = document.getElementById("handwritingLoading");

            const writingPrompt = document.getElementById("writingPrompt");
            const useImagePromptBtn = document.getElementById("useImagePromptBtn");
            const studentWriting = document.getElementById("studentWriting");
            const useExtractedBtn = document.getElementById("useExtractedBtn");
            const gradingProviderSelect = document.getElementById("gradingProviderSelect");
            const gradingModelSelect = document.getElementById("gradingModelSelect");
            const gradingModelInfo = document.getElementById("gradingModelInfo");
            const refreshGradingModelsBtn = document.getElementById("refreshGradingModelsBtn");
            const gradeWritingBtn = document.getElementById("gradeWritingBtn");
            const gradingLoading = document.getElementById("gradingLoading");
            const gradingResults = document.getElementById("gradingResults");
            const gradingOutput = document.getElementById("gradingOutput");
            const downloadGradingBtn = document.getElementById("downloadGradingBtn");

            const freeOnlyToggle = document.getElementById("freeOnlyToggle");
            const freeOnlyToggleHandwriting = document.getElementById("freeOnlyToggleHandwriting");
            const freeOnlyToggleGrading = document.getElementById("freeOnlyToggleGrading");

            let availableModels = [];
            let availableProviders = [];
            let currentImagePrompt = "";
            let freeOnly = true;

            function isFreeModel(model) {
                const p = model?.pricing;
                return p && (p.prompt === 0 || p.prompt === "0") && (p.completion === 0 || p.completion === "0");
            }

            function updateAllDropdowns() {
                updateProviderDropdown(providerSelect, m => true);
                updateModelDropdown(modelSelect, providerSelect.value, m => true);
                updateProviderDropdown(handwritingProviderSelect, m => m.architecture?.input_modalities?.includes('image'));
                updateModelDropdown(handwritingModelSelect, handwritingProviderSelect.value, m => m.architecture?.input_modalities?.includes('image'));
                updateProviderDropdown(gradingProviderSelect, m => m.architecture?.input_modalities?.includes('text'));
                updateModelDropdown(gradingModelSelect, gradingProviderSelect.value, m => m.architecture?.input_modalities?.includes('text'));
                setDefaultModels();
            }

            function onFreeOnlyChange() {
                freeOnly = this.checked;
                [freeOnlyToggle, freeOnlyToggleHandwriting, freeOnlyToggleGrading].forEach(toggle => toggle.checked = freeOnly);
                updateAllDropdowns();
            }

            async function loadModels(forceRefresh = false) {
                try {
                    const response = await fetch('https://openrouter.ai/api/v1/models');
                    const data = await response.json();
                    availableModels = data.data.sort((a, b) => (a.name || a.id).localeCompare(b.name || a.id));
                    const providers = new Set(availableModels.map(m => m.id.split('/')[0]));
                    availableProviders = Array.from(providers).sort();
                    updateAllDropdowns();
                } catch (error) {
                    console.error('Error loading models:', error);
                }
            }

            function updateProviderDropdown(selectElement, modelFilter) {
                const currentSelection = selectElement.value;
                selectElement.innerHTML = '<option value="">All Providers</option>';
                let providersToShow = availableProviders;
                if (freeOnly) {
                    providersToShow = availableProviders.filter(p => availableModels.some(m => m.id.startsWith(p + '/') && isFreeModel(m) && modelFilter(m)));
                }
                providersToShow.forEach(provider => {
                    const option = document.createElement('option');
                    option.value = provider;
                    option.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
                    selectElement.appendChild(option);
                });
                if (providersToShow.includes(currentSelection)) {
                    selectElement.value = currentSelection;
                }
            }

            function updateModelDropdown(selectElement, selectedProvider, modelFilter) {
                const currentSelection = selectElement.value;
                selectElement.innerHTML = '<option value="">Select a model...</option>';
                let modelsToShow = availableModels.filter(modelFilter);
                if (freeOnly) {
                    modelsToShow = modelsToShow.filter(isFreeModel);
                }
                if (selectedProvider) {
                    modelsToShow = modelsToShow.filter(model => model.id.startsWith(selectedProvider + '/'));
                }
                modelsToShow.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name || model.id;
                    selectElement.appendChild(option);
                });
                if (modelsToShow.some(m => m.id === currentSelection)) {
                    selectElement.value = currentSelection;
                }
            }

            function setDefaultModels() {
                const defaultModelExists = availableModels.some(m => m.id === DEFAULT_MODEL);
                if (defaultModelExists) {
                    [modelSelect, handwritingModelSelect, gradingModelSelect].forEach(select => {
                        if (Array.from(select.options).some(o => o.value === DEFAULT_MODEL)) {
                            select.value = DEFAULT_MODEL;
                        }
                    });
                    updateAllModelInfos();
                }
            }

            function updateAllModelInfos() {
                updateModelInfo(modelSelect, modelInfo);
                updateModelInfo(handwritingModelSelect, handwritingModelInfo);
                updateModelInfo(gradingModelSelect, gradingModelInfo);
            }

            function updateModelInfo(selectElement, infoElement) {
                const selectedModel = availableModels.find(m => m.id === selectElement.value);
                if (selectedModel) {
                    infoElement.textContent = `Context: ${selectedModel.context_length.toLocaleString()} | Input: ${selectedModel.architecture?.input_modalities?.join(', ')}`;
                } else {
                    infoElement.textContent = '';
                }
                updateButtonStates();
            }

            function updateButtonStates() {
                const apiKeyValid = apiKeyStatus.dataset.state === 'valid';
                generateBtn.disabled = !apiKeyValid || !modelSelect.value;
                extractTextBtn.disabled = !apiKeyValid || !handwritingModelSelect.value || !handwritingInput.files[0];
                gradeWritingBtn.disabled = !apiKeyValid || !gradingModelSelect.value || !writingPrompt.value || !studentWriting.value;
            }

            async function validateApiKey() {
                const key = apiKeyInput.value.trim();
                if (!key) {
                    setApiKeyStatus('unknown', 'Not validated');
                    return;
                }
                setApiKeyStatus('pending', 'Validating...');
                try {
                    const res = await fetch('https://openrouter.ai/api/v1/models', { headers: { 'Authorization': `Bearer ${key}` } });
                    if (res.ok) {
                        setApiKeyStatus('valid', 'API Key Valid');
                        if (rememberApiKey.checked) localStorage.setItem('openrouter_api_key', key);
                    } else {
                        setApiKeyStatus('invalid', 'API Key Invalid');
                    }
                } catch (err) {
                    setApiKeyStatus('error', 'Validation Error');
                }
            }

            function setApiKeyStatus(state, text) {
                apiKeyStatus.dataset.state = state;
                apiKeyStatus.textContent = text;
                updateButtonStates();
            }

            async function callApi(model, messages, loadingElement, resultElement, outputProcessor) {
                loadingElement.style.display = 'block';
                resultElement.style.display = 'none';
                try {
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKeyInput.value.trim()}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ model, messages }),
                    });
                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                    const data = await response.json();
                    outputProcessor(data.choices[0].message.content);
                } catch (error) {
                    alert(`Error: ${error.message}`);
                } finally {
                    loadingElement.style.display = 'none';
                    updateButtonStates();
                }
            }

            imageInput.addEventListener("change", (e) => handleImageUpload(e, imagePreview));
            handwritingInput.addEventListener("change", (e) => handleImageUpload(e, handwritingPreview));

            function handleImageUpload(event, previewElement) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        previewElement.src = e.target.result;
                        previewElement.style.display = "block";
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewElement.style.display = "none";
                }
                updateButtonStates();
            }

            generateBtn.addEventListener("click", () => {
                const hasImage = imageInput.files[0];
                const prompt = hasImage ? `Describe this image for a creative writing prompt.` : `Generate a creative writing prompt.`;
                let content = [{ type: 'text', text: prompt }];
                if (hasImage) {
                    content.push({ type: 'image_url', image_url: { url: imagePreview.src } });
                }
                callApi(modelSelect.value, [{ role: 'user', content }], loading, result, (res) => {
                    currentImagePrompt = res;
                    result.innerHTML = marked.parse(res);
                    result.style.display = 'block';
                    writingPrompt.value = res;
                });
            });

            extractTextBtn.addEventListener("click", () => {
                const prompt = `Extract all text from this handwriting image.`;
                const content = [{ type: 'text', text: prompt }, { type: 'image_url', image_url: { url: handwritingPreview.src } }];
                callApi(handwritingModelSelect.value, [{ role: 'user', content }], handwritingLoading, extractedText, (res) => {
                    extractedText.value = res;
                    studentWriting.value = res;
                });
            });

            function createGradingPrompt(writingPrompt, studentWriting) {
                return `## PURPOSE

You are an expert writing evaluator designed to provide comprehensive, consistent, and constructive feedback on GATE student writing. Your analysis combines technical assessment strictly following the writing assessment rubric below with empathetic guidance to help students improve their writing skills.

## QUICK REFERENCE

- Time Constraint: Student essays written in 25 minutes
- Scoring Range: 0-25 marks
- Output Format: Grading in Markdown format

## WRITING PROMPT

${writingPrompt}

## STUDENT WRITING

${studentWriting}

## EVALUATION PROTOCOL

### 1. EVALUATION PROCESS

A. First Pass: Holistic Review
- Read the complete essay, ensuring it is evaluated independently.
- Identify main themes and approaches.
- Note initial impressions.

B. Second Pass: Detailed Analysis

Score each criterion using the rubric below:

#### WRITING ASSESSMENT RUBRIC (25 MARKS)

1. **Story Structure and Plot Flow (2 marks)**
   - 2 marks: Clear beginning, middle, and end; logical sequence of events; smooth transitions.
   - 1 mark: Basic structure with awkward transitions; some events appear disconnected.
   - 0 marks: No clear structure; random events; confusing sequence.

2. **Topic Relevance (5 marks)**
   - 5 marks: The essay fully and consistently addresses the assigned prompt with deep, nuanced understanding; every section is directly relevant.
   - 4 marks: Largely addresses the prompt with minor deviations; most content is relevant with only slight off-topic areas.
   - 3 marks: Moderately addresses the prompt; key elements are included but with noticeable gaps or generalizations.
   - 2 marks: Limited engagement with the prompt; significant portions are off-topic.
   - 1 mark: Barely touches the topic with isolated references; largely off-topic.
   - 0 marks: Fails to address the prompt entirely.

3. **Atmosphere and Theme (2 marks)**
   - 2 marks: Vivid setting details that reinforce the theme; effective use of sensory cues.
   - 1 mark: Basic atmosphere with an inconsistent mood.
   - 0 marks: Lacks clear atmosphere and theme.

4. **Sensory Details (2 marks)**
   - 2 marks: Incorporates multiple sensory details naturally.
   - 1 mark: Some sensory details present, but they may feel forced.
   - 0 marks: Limited or superficial sensory detail.

5. **Character Development (2 marks)**
   - 2 marks: Main character displays clear growth and distinct personality.
   - 1 mark: Some development present; character traits are basic.
   - 0 marks: Flat characters with no development.

6. **Sizzling Start (1 mark)**
   - 1 mark: Begins with engaging action, dialogue, or intrigue.
   - 0 marks: Generic or slow start.

7. **Conflict Development (2 marks)**
   - 2 marks: Clear central conflict with creative complications and a satisfying resolution.
   - 1 mark: Basic conflict with predictable progression.
   - 0 marks: Unclear or absent conflict.

8. **Figurative Language (3 marks)**
   - 3 marks: Effective use of three or more types of figurative language.
   - 2 marks: Uses two types effectively.
   - 1 mark: Uses one type, or uses multiple types ineffectively.
   - 0 marks: No apparent use of figurative language.

9. **Moral/Theme Message (2 marks)**
   - 2 marks: Moral or underlying message is naturally and thoughtfully integrated.
   - 1 mark: Obvious or forced moral message.
   - 0 marks: Lacks a clear moral or message.

10. **Ending (2 marks)**
    - 2 marks: Concludes with a surprising yet logical ending; ties up loose ends.
    - 1 mark: Concludes adequately but predictably.
    - 0 marks: Abrupt or illogical ending.

11. **Original Idea (1 mark)**
    - 1 mark: Presents a fresh perspective or unique plot elements.
    - 0 marks: Relies on clichéd or derivative ideas.

12. **Technical Accuracy (1 mark)**
    - 1 mark: Few to no spelling/grammar errors and proper punctuation.
    - 0 marks: Frequent errors and poor technical execution.

### 2. FEEDBACK GENERATION

Please provide your assessment in the following format:

## Grading Report

### Detailed Rubric Assessment

**1. Story Structure and Plot Flow** (_/2 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**2. Topic Relevance** (_/5 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**3. Atmosphere and Theme** (_/2 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**4. Sensory Details** (_/2 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**5. Character Development** (_/2 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**6. Sizzling Start** (_/1 mark)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**7. Conflict Development** (_/2 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**8. Figurative Language** (_/3 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**9. Moral/Theme Message** (_/2 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**10. Ending** (_/2 marks)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**11. Original Idea** (_/1 mark)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

**12. Technical Accuracy** (_/1 mark)
- **Evidence:** [Direct quote or reference from the text]
- **Analysis:** [Specific evaluation]
- **Score Justification:** [Clear reasoning]
- **Improvement Strategy:** [Actionable advice]
- **Example of improvement:** [Improvement examples based on the advice above]

### Overall Assessment

- **Total Score:** _/25 (_%)
- **Key Strengths:** [3 specific elements]
- **Priority Improvements:** [3 actionable items]
- **Strategic Development Plan:** [Personalized roadmap]

Please evaluate the student's writing thoroughly and provide constructive feedback that will help them improve their writing skills.`;
            }

            gradeWritingBtn.addEventListener("click", () => {
                const gradingPrompt = createGradingPrompt(writingPrompt.value, studentWriting.value);
                callApi(gradingModelSelect.value, [{ role: 'user', content: gradingPrompt }], gradingLoading, gradingResults, (res) => {
                    gradingOutput.innerHTML = marked.parse(res);
                    gradingResults.style.display = 'block';
                    window.currentGradingResult = res;
                });
            });

            // Event Listeners Setup
            document.addEventListener('DOMContentLoaded', () => {
                loadModels();
                if (localStorage.getItem('openrouter_api_key')) {
                    apiKeyInput.value = localStorage.getItem('openrouter_api_key');
                    rememberApiKey.checked = true;
                    validateApiKey();
                }
            });
            validateApiKeyBtn.addEventListener("click", validateApiKey);
            clearApiKeyBtn.addEventListener("click", () => {
                apiKeyInput.value = '';
                localStorage.removeItem('openrouter_api_key');
                rememberApiKey.checked = false;
                setApiKeyStatus('unknown', 'Not validated');
            });
            [freeOnlyToggle, freeOnlyToggleHandwriting, freeOnlyToggleGrading].forEach(toggle => toggle.addEventListener('change', onFreeOnlyChange));
            [providerSelect, handwritingProviderSelect, gradingProviderSelect].forEach(select => select.addEventListener('change', () => updateAllDropdowns()));
            [modelSelect, handwritingModelSelect, gradingModelSelect].forEach(select => select.addEventListener('change', () => updateAllModelInfos()));
            useImagePromptBtn.addEventListener('click', () => writingPrompt.value = currentImagePrompt);
            useExtractedBtn.addEventListener('click', () => studentWriting.value = extractedText.value);
            downloadGradingBtn.addEventListener('click', () => {
                if (window.currentGradingResult) {
                    const blob = new Blob([window.currentGradingResult], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'grading_report.md';
                    a.click();
                    URL.revokeObjectURL(url);
                }
            });

        </script>
    </body>
</html>
